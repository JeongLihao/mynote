# 项目一

## halo

![image-20250725171825468](https://img.lhjeong.cn/20250725171825666.png)

### 1. jdk安装与配置

1. 安装

   ```sh
   # 更新软件包列表
   sudo apt update
   
   # 安装OpenJDK 17（推荐版本）
   sudo apt install openjdk-17-jdk -y
   
   # 验证安装
   java -version
   ```

   ![image-20250723170604079](https://img.lhjeong.cn/20250723170604326.png)

2. 安装21版本

   ```bash
   // 1. 在官网下载jdk-21_linux-x64_bin.deb
   // 2. 安装
         dpkg -i jdk-21_linux-x64_bin.deb
   ```

### 2. 创建数据库

1. 登录数据库

   ```sh
    mysql -u root -p
   ```

2. 创建数据库和用户

   ```sql
   CREATE DATABASE halo DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   
   CREATE USER 'halouser'@'192.168.231.1' IDENTIFIED BY '123456';
   
   GRANT ALL PRIVILEGES ON halo.* TO 'halouser'@'192.168.231.1';
   
   FLUSH PRIVILEGES;
   ```


### 3. 安装halo

1. 创建存放运行包的目录

   ```sh
   mkdir ~/app 
   cd ~/app
   ```

2. 下载运行包

   ```sh
   wget https://dl.halo.run/release/halo-2.21.0.jar -O halo.jar
   ```

3. 创建工作目录

   ```sh
   mkdir ~/.halo2 
   cd ~/.halo2
   ```

4. 创建配置文件

   ```yaml
   # vim application.yaml
   server:
   # 运行端口
   port: 8090
   spring:
     # 数据库配置
     r2dbc:
       # url: r2dbc:h2:file:///${halo.work-dir}/db/halo-next?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
       url: r2dbc:pool:mysql://192.168.231.3:3307/halo
       username: halouser
       password: 123456
     sql:
       init:
         mode: always
         # 需要配合 r2dbc 的配置进行改动
         platform: mysql
   halo:
     # 工作目录位置
     work-dir: ${user.home}/.halo2
     # 外部访问地址
     external-url: http://halo.mxdx.com:8090
     # 附件映射配置，通常用于迁移场景
     attachment:
       resource-mappings:
         - pathPattern: /upload/**
           locations:
             - migrate-from-1.x
   ```

   ![image-20250724102110280](https://img.lhjeong.cn/20250724102110697.png)

5. 测试运行

   ```sh
   cd ~/app && java -Dfile.encoding=UTF-8 -jar halo.jar --spring.config.additional-location=optional:file:$HOME/.halo2/
   
   # 通过http://ip:端口号查看网页并进行初始化
   ```

### 4. 作为服务运行

1. 创建`halo.service`文件

   ```sh
   [Unit]
   Description=Halo Service
   Documentation=https://docs.halo.run
   After=network-online.target
   Wants=network-online.target
   
   [Service]
   Type=simple
   User=root
   ExecStart=/usr/bin/java -Dfile.encoding=UTF-8 -server -Xms256m -Xmx256m -jar /root/app/halo.jar --spring.config.additional-location=optional:file:/root/.halo2/
   ExecStop=/bin/kill -s QUIT $MAINPID
   Restart=always
   StandardOutput=journal
   StandardError=inherit
   
   [Install]
   WantedBy=multi-user.target
   ```

2. 重新加载

   ```sh
   systemctl daemon-reload
   ```

3. 运行服务

   ```sh
   systemctl start halo
   ```

4. 开机自启

   ```sh
   systemctl enable halo
   ```

5. 查看日志

   ```sh
   journalctl -u halo -f
   ```

### 5. 反向代理配置

1. 创建配置文件

   ```sh
   upstream halo {
       server 127.0.0.1:8090;
   }
   
   server {
       listen 80;
       listen [::]:80;
       server_name halo.mxdx.com;
   
       # 上传附件大小限制
   
       client_max_body_size 100m;
   
       location / {
           proxy_pass http://halo;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

2. 检查并重启nginx

   ```sh
   nginx -t
   nginx -s reload
   ```

# 项目二

##  dash-fastapi-admin

![image-20250725171901214](https://img.lhjeong.cn/20250725171901584.png)

### 1. 环境准备与代码获取

1. 安装必要组件

   ```sh
   apt update
   apt install -y python3 python3-venv python3-pip git
   ```

2. 创建项目目录与虚拟环境

   ```sh
   cd /opt
   mkdir dash-admin
   chown root:root dash-admin
   cd dash-admin
   python3 -m venv venv
   source venv/bin/activate
   ```

3. 拉取代码

   ```sh
   git clone https://gitee.com/insistence2022/dash-fastapi-admin.git
   ```

4. 安装py依赖包

   ```sh
   // 这里应该进入刚刚拉取的目录，然后执行
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

   + 如果发生超时，可执行

     ```sh
     pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
     ```

   + 或者执行

     ```ini
     vim /etc/pip.conf
     
     [global]
     index-url = https://pypi.tuna.tsinghua.edu.cn/simple
     timeout = 60
     ```

   ![image-20250724111147334](https://img.lhjeong.cn/20250724111147379.png)

### 2. 配置数据库连接

1. 创建数据库和用户

   ```sql
   CREATE DATABASE dash DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   
   CREATE USER 'dashuser'@'192.168.231.1' IDENTIFIED BY '123456';
   GRANT ALL PRIVILEGES ON dash.* TO 'dashuser'@'192.168.231.1';
   FLUSH PRIVILEGES;
   ```

   ![image-20250724111043802](https://img.lhjeong.cn/20250724111044024.png)

2. 配置.env文件（在项目目录）

   ```ini
   # 数据库连接配置（MySQL 在 192.168.231.3，端口 3307）
   DATABASE_URL=mysql+pymysql://dashuser:123456@192.168.231.3:3307/dash
   
   # Redis 服务地址（Redis 也在 192.168.231.3，默认端口 6379，使用第 0 号数据库）
   REDIS_URL=redis://192.168.231.3:6379/0
   
   # Celery 任务队列配置，使用 Redis 作为消息中间件和结果存储
   CELERY_BROKER_URL=redis://192.168.231.3:6379/0
   CELERY_RESULT_BACKEND=redis://192.168.231.3:6379/0
   
   # FastAPI 服务监听配置
   HOST=0.0.0.0
   PORT=8000
   
   # Dash UI 前端监听端口
   DASH_PORT=8050
   ```

3. 测试连接

   1. mysql测试

      ```py
      python
      
      import sqlalchemy
      from sqlalchemy import text
      
      db_url = "mysql+pymysql://dashuser:123456@192.168.231.3:3307/dash"
      engine = sqlalchemy.create_engine(db_url)
      
      try:
          with engine.connect() as conn:
              result = conn.execute(text("SELECT VERSION();"))
              print(result.fetchone())
          print("数据库连接成功！")
      except Exception as e:
          print(f"数据库连接失败: {e}")
      ```

      ![image-20250724112817193](https://img.lhjeong.cn/20250724112817372.png)

   2. redis测试

      1. 下载客户端工具

         ```sh
         apt update
         apt install redis-tools
         ```

      2. 测试

         ```
         redis-cli -h 192.168.231.3 -p 6379 -a 123456 ping
         ```

         应返回`PONG`

4. 如果没有连接成功，请尝试如下方式

   1. 切换到`/opt/dash-admin/dash-fastapi-admin/dash_fastapi_backend`

   2. 修改`.env.dev`

      ```ini
      # -------- 数据库配置 --------
      # 数据库类型，可选的有'mysql'、'postgresql'，默认为'mysql'
      DB_TYPE = 'mysql'
      # 数据库主机
      DB_HOST = '192.168.231.3'
      # 数据库端口
      DB_PORT = 3307
      # 数据库用户名
      DB_USERNAME = 'dashuser'
      # 数据库密码
      DB_PASSWORD = '123456'
      # 数据库名称
      DB_DATABASE = 'dash'
      # 是否开启sqlalchemy日志
      DB_ECHO = true
      # 允许溢出连接池大小的最大连接数
      DB_MAX_OVERFLOW = 10
      # 连接池大小，0表示连接数无限制
      DB_POOL_SIZE = 50
      # 连接回收时间（单位：秒）
      DB_POOL_RECYCLE = 3600
      # 连接池中没有线程可用时，最多等待的时间（单位：秒）
      DB_POOL_TIMEOUT = 30
      
      # -------- Redis配置 --------
      # Redis主机
      REDIS_HOST = '192.168.231.3'
      # Redis端口
      REDIS_PORT = 6379
      # Redis用户名
      REDIS_USERNAME = ''
      # Redis密码
      REDIS_PASSWORD = '123456'
      # Redis数据库
      REDIS_DATABASE = 0
      ```

   3. 修改`.env.prod`

      ```ini
      # -------- 数据库配置 --------
      # 数据库类型，可选的有'mysql'、'postgresql'，默认为'mysql'
      DB_TYPE = 'mysql'
      # 数据库主机
      DB_HOST = '192.168.231.3'
      # 数据库端口
      DB_PORT = 3307
      # 数据库用户名
      DB_USERNAME = 'dashuser'
      # 数据库密码
      DB_PASSWORD = '123456'
      # 数据库名称
      DB_DATABASE = 'dash'
      # 是否开启sqlalchemy日志
      DB_ECHO = true
      # 允许溢出连接池大小的最大连接数
      DB_MAX_OVERFLOW = 10
      # 连接池大小，0表示连接数无限制
      DB_POOL_SIZE = 50
      # 连接回收时间（单位：秒）
      DB_POOL_RECYCLE = 3600
      # 连接池中没有线程可用时，最多等待的时间（单位：秒）
      DB_POOL_TIMEOUT = 30
      
      # -------- Redis配置 --------
      # Redis主机
      REDIS_HOST = '192.168.231.3'
      # Redis端口
      REDIS_PORT = 6379
      # Redis用户名
      REDIS_USERNAME = ''
      # Redis密码
      REDIS_PASSWORD = '123456'
      # Redis数据库
      REDIS_DATABASE = 0
      ```

### 3. 服务运行测试

1. 激活虚拟环境

   ```sh
   cd /opt/dash-admin
   source venv/bin/activate
   ```

2. 将数据导入数据库

   ```
   cd /opt/dash-admin/dash-fastapi-admin/dash_fastapi_backend/sql
   将dash-fastapi.sql导入mysql
   ```

2. 启动fastapi后端

   ```sh
   cd dash-fastapi-admin/dash_fastapi_backend
   uvicorn server:app --host 0.0.0.0 --port 8000 --reload
   ```

3. 启动dash前端界面

   ```sh
   cd dash-fastapi-admin
   python dash-fastapi-frontend/app.py
   ```

### 4. 守护进程配置

1. 下载

   ```sh
   apt install supervisor
   ```

2. 创建配置文件（/etc/supervisor/conf.d/）

   1. 页面进程

      ```ini
      [program:dash]
      command=/opt/dash-admin/venv/bin/python /opt/dash-admin/dash-fastapi-admin/dash-fastapi-frontend/app.py
      directory=/opt/dash-admin/dash-fastapi-admin/dash-fastapi-frontend/
      autostart=true
      autorestart=true
      stderr_logfile=/var/log/dash-fastapi-admin-frontend.err.log
      stdout_logfile=/var/log/dash-fastapi-admin-frontend.out.log
      user=root
      environment=PATH="/opt/dash-admin/venv/bin:$PATH"
      ```

   2. 后端进程

      ```ini
      [program:dash-fastapi-admin]
      command=/opt/dash-admin/venv/bin/uvicorn server:app --host 192.168.231.1 --port 8000
      directory=/opt/dash-admin/dash-fastapi-admin/dash_fastapi_backend
      autostart=true
      autorestart=true
      stderr_logfile=/var/log/dash-fastapi-admin.err.log
      stdout_logfile=/var/log/dash-fastapi-admin.out.log
      user=root
      environment=PATH="/opt/dash-admin/venv/bin:$PATH"
      ```

   3. 启动supervisor

      ```sh
      supervisorctl reread
      supervisorctl reread
      supervisorctl start dash-fastapi-admin
      supervisorctl start dash
      
      // 查看
      supervisorctl status
      ```

   + 打开页面后如果报错，可以查看监听ip是否一致，本文为`192.168.231.1:8000`

     1. 打开`/opt/dash-admin/dash-fastapi-admin/dash-fastapi-frontend`

     2. `.env.dev`

        ```ini
        # -------- 应用配置 --------
        # 应用运行环境
        APP_ENV = 'dev'
        # 应用名称
        APP_NAME = 'DF Admin'
        # 应用请求后端url
        #APP_BASE_URL = 'http://127.0.0.1:8000'
        APP_BASE_URL = 'http://192.168.231.1:8000'
        # 后端是否使用代理模式
        APP_IS_PROXY = false
        # 应用代理路径
        APP_PROXY_PATH = ''
        # 应用秘钥
        APP_SECRET_KEY = 'Dash-FastAPI-Admin'
        # 应用主机
        APP_HOST = '0.0.0.0'
        # 应用端口
        APP_PORT = 8088
        # 应用版本
        APP_VERSION= '2.1.1'
        # 应用是否开启debug模式
        APP_DEBUG = true
        # flask-compress压缩配置
        APP_COMPRESS_ALGORITHM = 'br'
        APP_COMPRESS_BR_LEVEL = 11
        
        # -------- 缓存配置 --------
        # LRU缓存的限制数量，0表示无限制
        LRU_CACHE_MAXSIZE = 10000
        # LRU缓存不重新分配的容量
        LRU_CACHE_CAPACITY = 10000
        # TTL缓存的限制数量，0表示无限制
        TTL_CACHE_MAXSIZE = 0
        # TTL缓存过期时间（秒）
        TTL_CACHE_EXPIRE = 600
        ```

     3. `.env.prod`

        ```ini
        # -------- 应用配置 --------
        # 应用运行环境
        APP_ENV = 'prod'
        # 应用名称
        APP_NAME = 'DF Admin'
        # 应用请求后端url
        #APP_BASE_URL = 'http://127.0.0.1:8000'
        APP_BASE_URL = 'http://192.168.231.1:8000'
        # 后端是否使用代理模式
        APP_IS_PROXY = true
        # 应用代理路径
        APP_PROXY_PATH = '/prod-api'
        # 应用秘钥
        APP_SECRET_KEY = 'Dash-FastAPI-Admin'
        # 应用主机
        APP_HOST = '0.0.0.0'
        # 应用端口
        APP_PORT = 8088
        # 应用版本
        APP_VERSION= '2.1.1'
        # 应用是否开启debug模式
        APP_DEBUG = false
        # flask-compress压缩配置
        APP_COMPRESS_ALGORITHM = 'br'
        APP_COMPRESS_BR_LEVEL = 11
        
        # -------- 缓存配置 --------
        # LRU缓存的限制数量，0表示无限制
        LRU_CACHE_MAXSIZE = 10000
        # LRU缓存不重新分配的容量
        LRU_CACHE_CAPACITY = 10000
        # TTL缓存的限制数量，0表示无限制
        TTL_CACHE_MAXSIZE = 0
        # TTL缓存过期时间（秒）
        TTL_CACHE_EXPIRE = 600
        ```

### 5. nginx反向代理

1. 打开文件夹

   ```sh
   cd /etc/nginx/conf.d
   vim dash.mxdx.com.conf
   ```

2. 写入配置文件

   ```ini
   server {
       listen 80;
       server_name dash.mxdx.com;
   	
       location / {
           proxy_set_header Host $http_host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header REMOTE-HOST $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass http://192.168.231.1:8088/;
       }
   
       location /prod-api {
           proxy_set_header Host $http_host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header REMOTE-HOST $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_pass http://192.168.231.1:8088/;
           rewrite ^/prod-api/(.*)$ /$1 break;
       }
       error_page   500 502 503 504  /50x.html;
       location = /50x.html {
           root   html;
       }
   }
   ```

3. 确认并重启

   ```sh
   nginx -t
   nginx -s reload
   ```

   


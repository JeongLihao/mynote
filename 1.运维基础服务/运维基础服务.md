# 运维基础服务实践

+ 本文档包含web服务器，数据库以及dns、文件共享及邮件的安装与配置
+ 本文档的顺序基于运维基础服务实践
+ 本文档基于debian系统

## 一、基础环境准备

+ 部署三台debian服务器
  + debian1：dns + web服务
  + debian2：文件共享 + 邮件服务
  + debian3：数据库服务
  + 保证三台服务器ssh互通即可
+ 编辑/etc/network/interfaces设置静态

## 二、核心服务部署

### 1. 统一dns服务（bind9）

1. 安装bind9服务

   ```sh
   apt update
   apt install bind9
   ```

2. 配置主配置文件

   ```sh
   vim /etc/bind/named.conf.options
   
   // 将options{}修改为
   options {
       directory "/var/cache/bind";
   
       recursion yes;
       allow-query { any; };
   
       forwarders {
           8.8.8.8;
           114.114.114.114;
       };
   
       dnssec-validation auto;
   
       listen-on { any; };
   };
   
   // 开启 recursion 允许本地客户端解析外网。
   // 设置 forwarders 实现外部域名解析能力。
   // listen-on { any; }; 允许监听所有网卡
   // 可增加listen-on-v6{ none;}防止IPV6误报
   ```

   ![image-20250707221140891](https://img.lhjeong.cn/20250707221140999.png)

3. 配置主区域文件

   ```sh
   vim /etc/bind/named.conf.local
   
   zone "mxdx.com" {
       type master;
       file "/etc/bind/db.mxdx.com";
   };
   // 经测试，该内容可以放在named.conf.options里，但出于规范，理应写在该文件中
   // 不过如果只是测试，本文推荐写在一个文件里方便管理
   ```

4. 编写区域数据文件

   + 复制默认模板文件并修改

     ```sh
     cp /etc/bind/db.local /etc/bind/db.mxdx.com
     vim /etc/bind/db.mxdx.com
     ```

   + 将内容修改为如下内容

     ```sh
     $TTL    604800
     @       IN      SOA     dns.mxdx.com. root.mxdx.com. (
                            20250707         ; Serial
                              604800         ; Refresh
                               86400         ; Retry
                             2419200         ; Expire
                              604800 )       ; Negative Cache TTL
     
     @       IN      NS      dns.mxdx.com.
     dns     IN      A       192.168.28.1
     web     IN      A       192.168.28.1
     files   IN      A       192.168.28.2
     ftp     IN      A       192.168.28.2
     mail    IN      A       192.168.28.2
     mysql   IN      A       192.168.28.3
     pgsql   IN      A       192.168.28.3
     redis   IN      A       192.168.28.3
     
     // 域名的SOA记录必须正确，主机名后需加 . 表示绝对域名
     // 修改后可以考虑手动增加serial序列号(配置中的20250707)
     ```

5. 检查配置是否正确

   + 执行 Bind 配置语法校验

     ```sh
     named-checkconf
     ```

   + 检查区域数据文件是否正确

     ```bash
     named-checkzone mxdx.com /etc/bind/db.mxdx.com
     ```

   + 输出应类似

     ```bash
     zone mxdx.com/IN: loaded serial 2
     OK
     ```

6. 重启dns服务

   ```sh
   systemctl restart bind9
   
   // 可设置开机自启
      systemctl enable named
   ```

7. 在本机测试解析功能

   ```sh
   dig @127.0.0.1 dns.mxdx.com
   dig @127.0.0.1 web.mxdx.com
   ```

8. 让其他主机使用该dns服务

   ```sh
   // 在虚拟机网卡设置(/etc/network/interfaces)中
      dns-nameservers 192.168.28.1
   // 或者修改/etc/resolv.conf
      nameserver 192.168.28.1
   // 测试
      dig dns.mxdx.com
      dig mysql.mxdx.com
   ```

9. 外网连接测试（检测能否解析外网域名）

   ```sh
   dig www.baidu.com
   
   // 如果不能解析或无法ping通
      1. 检查默认DNS
      2. 检查named.conf.options对forwarders的配置
   ```

### 2. 文件共享服务（samba + vsftpd + nfs）

#### 1. samba

1. 安装samba服务

   ```sh
   apt update
   apt install samba
   ```

2. 创建共享目录及用户

   ```sh
   mkdir -p /srv/samba/share
   groupadd smbgroup
   useradd -s /sbin/nologin -G smbgroup smbuser
   chown -R smbuser:smbgroup /srv/samba/share
   chmod -R 770 /srv/samba/share
   ```

3. 设置samba用户密码

   ```sh
   smbpasswd -a smbuser
   ```

4. 编辑主配置文件

   ```sh
   vim /etc/samba/smb.conf
   
   [Share]
       path = /srv/samba/share
       browseable = yes
       read only = no
       guest ok = no
       valid users = smbuser
   
   // 在文件末尾添加，不要改动文件中其他东西
   ```

   ![image-20250707225146645](https://img.lhjeong.cn/20250707225146704.png)

5. 重启服务

   ```sh
   systemctl restart smbd
   systemctl enable smbd
   ```

6. 验证共享是否启用

   ```sh
   smbclient -L localhost -U smbuser
   
   // 输入刚刚设置的密码
   ```

7. 在win端访问共享

   ```sh
   // 在文件资源管理器中
      \\files.mxdx.com
      
   // 不要勾选保存凭证
   ```

#### 2. vsftpd

1. 安装

   ```sh
   apt update
   apt install vsftpd
   
   // 确认状态
   systemctl status vsftpd
   ```

2. 编辑配置文件

   ```sh
   vim /etc/vsftpd.conf
   // 确认修改或取消注释以下内容
   
   listen=YES
   anonymous_enable=NO
   local_enable=YES                        # 禁止匿名登录
   write_enable=YES                        # 允许本地用户登录
   chroot_local_user=YES
   allow_writeable_chroot=YES
   pasv_min_port=30000
   pasv_max_port=31000
   pasv_address=192.168.231.2              # 文件服务器的IP地址（替换成你的）
   pasv_enable=YES
   
   // 如果你有域名,可改为pasv_address=XXX.com；减少IP变动的修改工作量
   ```

3. 重启服务

   ```sh
   systemctl restart vsftpd
   ```

4. 创建ftp用户及目录

   ```sh
   // 用户为su，本文档的远程连接用户基本都是su
   adduser su
   mkdir -p /home/su/ftp
   chown nobody:nogroup /home/su/ftp
   chmod a-w /home/su/ftp
   mkdir -p /home/su/ftp/files
   chown su:su /home/su/ftp/files
   ```

5. 使用win端的filezilla应用进行连接

   ```sh
   主机：ftp.mxdx.com 或 192.168.231.2
   用户名/密码：su / 用户密码
   ```

   ![image-20250707231046024](https://img.lhjeong.cn/20250707231046066.png)

#### 3. nfs服务

1. 安装

   ```sh
   apt install nfs-kernel-server
   ```

2. 创建共享目录并配置权限

   ```sh
   mkdir -p /home/su/nfs_share
   chown su:su /home/su/nfs_share
   ```

3. 写入共享配置

   ```sh
   vim /etc/exports
   // 在文件末尾添加
   /home/su/nfs_share 192.168.231.0/24(rw,sync,no_subtree_check)
   ```

   ![image-20250707230920797](https://img.lhjeong.cn/20250707230920877.png)

4. 应用配置并重启服务

   ```sh
   exportfs -a
   systemctl restart nfs-server
   ```

5. 测试（使用另一台debian服务器）

   ```sh
   apt install nfs-common
   mkdir -p /mnt/nfs_test
   mount 192.168.231.2:/home/su/nfs_share /mnt/nfs_test
   ```

### 3. 多数据库部署

+ 测试使用：navicat

#### 1. mysql

+ 在安装测试中发现mysql与mariadb存在冲突，在安装maria后，mysql似乎被替换，因此本文采取官方二进制包安装（当然，本文在后续测试中发现，docker也可以用在mysql上）

+ 本文强烈建议mysql先安装从而尽量避开maria先安装后带来的插件问题

+ 使用navicat测试时不要有多余的空格

+ 发生错误后，请检查文件权限

+ 建议安装前先下载

  ```sh
  apt update
  apt install libnuma1
  ```

1. [mysql下载链接](https://cdn.mysql.com/archives/mysql-8.0/mysql-8.0.33-linux-glibc2.28-x86_64.tar.gz)

2. 解压并移动

   ```sh
   tar -xvf mysql-8.0.33-linux-glibc2.28-x86_64.tar.gz -C /usr/local
   mv /usr/local/mysql-8.0.33-linux-glibc2.28-x86_64 /usr/local/mysql
   ```

3. 创建 MySQL 用户并准备数据目录

   ```sh
   useradd -r -s /bin/false mysql
   mkdir -p /data/mysql
   chown -R mysql:mysql /data/mysql /usr/local/mysql
   ```

4. 初始化数据库

   ```sh
   cd /usr/local/mysql
   ./bin/mysqld --initialize --user=mysql --datadir=/data/mysql
   
   // 建议使用
   ./bin/mysqld --initialize-insecure --user=mysql --datadir=/data/mysql
   ```

5. 配置自定义配置文件

   ```sh
   * mysql与mariadb都监听3306，因此本文将监听端口设为3307 
   
   vim /etc/my.cnf
   
   [mysqld]
   user=mysql
   basedir=/usr/local/mysql
   datadir=/data/mysql
   port=3307
   socket=/tmp/mysql.sock
   bind-address=0.0.0.0
   ```

6. 启动服务

   ```sh
   /usr/local/mysql/bin/mysqld_safe --defaults-file=/etc/my.cnf &
   ```

7. 获取root初始密码

   ```sh
   grep 'A temporary password' /data/mysql/*.err
   ```

8. 登录数据库修改root密码

   ```sh
   /usr/local/mysql/bin/mysql -u root -p
   
   ALTER USER 'root'@'localhost' IDENTIFIED BY 'MyNew@123';
   
   // 假设你忘记了上一步
   // 执行跳过权限表模式
   /usr/local/mysql/bin/mysqld_safe --skip-grant-tables --skip-networking &
   // 新建一个用户，然后用该用户登录即可
   CREATE USER 'su'@'%' IDENTIFIED BY 'su123456';
   // 登录后修改root密码
   ```

9. 授权远程访问用户

   ```sh
   // 在mysql中添加用户
      CREATE USER 'su'@'%' IDENTIFIED BY '123456';
   // 授予该用户所有权限
      GRANT ALL PRIVILEGES ON *.* TO 'su'@'%' WITH GRANT OPTION;
   // 刷新权限
      FLUSH PRIVILEGES;
      
   // 本文将端口改为3307，因此使用navicat时应修改端口
   ```

10. 使用docker安装mysql（后续测试新增）

    ```sh
    #1. 安装docker
    apt update
    apt install docker.io
    systemctl enable docker
    #2. 拉取镜像
    docker pull mysql:8.0
    #3. 运行容器
    docker run -d \
      --name mysql8 \
      -e MYSQL_ROOT_PASSWORD=123456 \
      -p 3306:3306 \
      -v /opt/mysql/data:/var/lib/mysql \
      mysql:8.0
    #4. 查看状态
    docker ps
    #5. 登录测试
    docker exec -it mysql8 mysql -uroot -p
    ```

#### 2. mariadb

+ 执行第一步前需关闭mysql，须保证进程彻底被杀死

1. 安装

   ```sh
   apt update
   apt install mariadb-server
   ```

2. 启动

   ```sh
   systemctl enable mariadb
   systemctl start mariadb
   ```

3. 远程访问配置

   ```sh
   vim /etc/mysql/mariadb.conf.d/50-server.cnf
   
   # bind-address = 127.0.0.1
     bind-address = 0.0.0.0
   ```

4. 重启

   ```sh
   systemctl restart mariadb
   ```

5. 授权

   ```sh
   CREATE USER 'su'@'%' IDENTIFIED BY 'su123456';
   GRANT ALL PRIVILEGES ON *.* TO 'su'@'%' WITH GRANT OPTION;
   FLUSH PRIVILEGES;
   ```

#### 3. postgresql

1. 安装

   ```sh
   apt update
   apt install postgresql postgresql-contrib
   ```

2. 启动

   ```sh
   systemctl enable postgresql
   systemctl start postgresql
   ```

3. 远程访问配置

   ```sh
   vim /etc/postgresql/15/main/pg_hba.conf
   
   host    all             all             0.0.0.0/0               md5
   
   vim /etc/postgresql/15/main/postgresql.conf
   // 找到并修改为一面这行
   listen_addresses = '*'
   ```

   ![image-20250708083838103](https://img.lhjeong.cn/20250708083845625.png)

4. 重启

   ```sh
   systemctl restart postgresql
   ```

5. 创建用户与数据库

   ```sh
   // 1. 切换到postgres用户
         su postgres
         psql
   // 2. 创建用户
   	  CREATE USER su WITH PASSWORD 'su123456';
         ALTER USER su WITH SUPERUSER;
   // 3. 创建数据库
         CREATE DATABASE mxdxdb OWNER su;
   // 4. 退出psql和postgres
   ```

#### 4. redis

1. 安装

   ```sh
   apt update
   apt install redis-server
   ```

2. 启动

   ```sh
   systemctl enable redis-server
   systemctl start redis-server
   ```

3. 配置远程访问

   ```sh
   vim /etc/redis/redis.conf
   
   bind 0.0.0.0
   protected-mode no
   ```

4. 重启

   ```sh
   systemctl restart redis-server
   ```

5. 密码（可选服务）

   ```sh
   // 编辑/etc/redis/redis.conf
      requirepass 你的密码
   // 重启服务
      systemctl restart redis-server
   ```

#### 5. mongodb

+ 官方源没有，所以这里需添加清华大学镜像

1. 信任公钥并下载

   ```sh
   wget -qO - https://www.mongodb.org/static/pgp/server-8.0.asc | gpg --dearmor -o /etc/apt/keyrings/mongodb-server-8.0.gpg
   
   // 配置源
   vim /etc/apt/sources.list.d/mongodb.list
   deb [signed-by=/etc/apt/keyrings/mongodb-server-8.0.gpg] https://mirrors.tuna.tsinghua.edu.cn/mongodb/apt/debian bookworm/mongodb-org/8.0 main
   
   apt update
   apt install mongodb-org
   
   // 假设你之前有安装过但失败，请先执行下列命令
   // 1. 删除添加的源
         rm -f /etc/apt/sources.list.d/mongodb*.list
   // 2. 删除旧密钥
         rm -f /etc/apt/keyrings/mongodb-server-8.0.gpg
         rm -f /usr/share/keyrings/mongodb-server-8.0.gpg
   // 3. 创建密钥目录
         mkdir -p /etc/apt/keyrings
   // 4. 导入密钥，然后继续执行配置源
   curl -fsSL https://pgp.mongodb.com/server-8.0.asc |gpg --dearmor -o /etc/apt/keyrings/mongodb-server-8.0.gpg
   ```

2. 启动

   ```sh
   systemctl enable mongod
   systemctl start mongod
   ```

3. 配置远程访问

   ```sh
   vim /etc/mongod.conf
   
   net:
     port: 27017
     bindIp: 0.0.0.0
   ```

   ![image-20250708091107492](https://img.lhjeong.cn/20250708091107539.png)

4. 重启

   ```sh
   systemctl restart mongod
   ```

5. 配置用户

   1. 确认服务状态

      ```sh
      systemctl start mongod
      ```

   2. 连接mongodb

      ```sh
      mongosh
      ```

   3. 创建管理员用户

      ```sh
      use admin;
      db.createUser({user: "su", pwd: "123456", roles: [ { role: "root", db: "admin" } ]})
      ```
   
   4. 启用认证
   
      ```sh
      vim /etc/mongod.conf
      
      security:
        authorization: enabled
      ```
   
      ![image-20250708092016724](https://img.lhjeong.cn/20250708092016763.png)
   
   5. 重启服务
   
      ```sh
      systemctl restart mongod
      ```

#### 6. sqlserver

+ 由于debian12微软未提供官方源，故使用docker安装
+ 使用navicat连接时可能出现`[IM002] [Microsoft][ODBC 驱动程序管理器] 未发现数据源名称并且未指定默认驱动程序`此时请前往微软官网下载[驱动](https://learn.microsoft.com/zh-cn/sql/connect/odbc/download-odbc-driver-for-sql-server?view=sql-server-ver16)

1. 安装docker

   ```sh
   apt update
   apt install docker.io
   ```

2. 拉取并运行

   ```sh
   docker pull mcr.microsoft.com/mssql/server:2022-latest
   // 出错可尝试执行
   sysctl -w net.ipv6.conf.all.disable_ipv6=1
   
   
   docker run -e 'ACCEPT_EULA=Y' -e 'MSSQL_SA_PASSWORD=123456@Ok' -p 1433:1433 --name mssql2022 -d mcr.microsoft.com/mssql/server:2022-latest
   
   * 密码需八位及以上，过于简单会报错
   ```

3. 验证运行状态

   ```sh
   docker ps
   ```

### 4. web服务部署

#### 1. nginx

1. 安装

   ```sh
   apt update
   apt install nginx
   ```

2. 配置反向代理

   ```sh
   vim /etc/nginx/conf.d/nginx.mxdx.com.conf
   
   server {
       listen 80;
       server_name nginx.mxdx.com;
       
       root /var/www/html;
       index index.nginx-debian.html;
   }
   ```

3. 测试配置语法并重启

   ```sh
   nginx -t
   nginx -s reload

4. 启动并设置开机自启

   ```sh
   systemctl start nginx
   systemctl enable nginx
   ```

5. 中文乱码

   ```sh
   // 在测试过程中发现中文乱码问题，本文提供一种解决方法
   // 在你的配置文件(/etc/nginx/conf.d/nginx.mxdx.com.conf)中加入
      charset utf-8;
   ```

#### 2. apache

1. 安装

   ```sh
   apt update
   apt install apache2
   ```

2. 启动并设置开机自启

   ```sh
   systemctl start apache2
   systemctl enable apache2
   ```

3. 端口检查

   ```sh
   Apache 默认监听 80 端口，但可能和 Nginx 产生冲突
   实际操作中，将 Apache 端口改为 8080 以避免冲突
   ```

4. 修改监听端口及虚拟主机配置

   ```sh
   vim /etc/apache2/ports.conf
   Listen 8080
   
   // vim /etc/apache2/sites-available/000-default.conf
   # <VirtualHost *:80>
   <VirtualHost *:8080>
   ```

5. 重启

   ```sh
   systemctl restart apache2
   ```

#### 3. tomcat 10

1. 安装

   ```sh
   apt update
   apt install tomcat10
   ```

2. 启动并设置开机自启

   ```sh
   systemctl start tomcat10
   systemctl enable tomcat10
   ```

3. 修改默认端口

   ```sh
   // apache占用了8080，本文档在这里修改为8081
   vim /etc/tomcat10/server.xml
   
   <Connector port="8080" protocol="HTTP/1.1"
              connectionTimeout="20000"
              redirectPort="8443" />
   ```

   ![image-20250708113702743](https://img.lhjeong.cn/20250708113702817.png)

4. 重启并检查服务状态

   ```bash
   systemctl restart tomcat10
   systemctl status tomcat10
   ```

### 5. 邮件服务部署

+ 可采用Thunderbird进行测试

#### 一、postfix邮件服务

1. 安装

   ```sh
   apt install postfix
   
   // 配置类型
      Internet Site
   // 系统邮件名
      mxdx.com
   ```

2. 配置

   1. 编辑主配置文件

      ```sh
      vim /etc/postfix/main.cf
      
      myhostname = mail.mxdx.com
      mydomain = mxdx.com
      myorigin = $mydomain
      mydestination = $myhostname, mxdx.com, localhost.localdomain, localhost
      inet_interfaces = all
      inet_protocols = ipv4
      ```

3. 重启

   ```sh
   systemctl restart postfix
   ```

#### 二、测试发信功能

1. 本地测试发信

   ```sh
   apt install mailutils -y
   echo "测试邮件内容" | mail -s "测试收件" root@mxdx.com
   
   // 发件给外网邮件
   echo "早上好" | mail -s "测试" -r root@mail.mxdx.com 收件人@xx.com
   ```

2. 查看收件箱

   ```sh
   mail
   // 当然，经过测试发现，mail似乎看不到，因此本文推荐使用下列方法
   apt install mutt
   maildirmake.dovecot /root/Maildir
   ls /root/Maildir
   mutt -f ~/Maildir
   
   // 编辑/etc/postfix/main.cf
      home_mailbox = Maildir/
   // 重启
      systemctl restart postfix
   ```

#### 三、dovecot及IMAP收信功能

1. 下载

   ```sh
   apt install dovecot-core dovecot-imapd
   ```

2. 确认配置

   ```bash
   vim /etc/dovecot/conf.d/10-mail.conf
   
   mail_location = maildir:~/Maildir
   ```

3. 设置权限

   ```bash
   chmod -R 700 /etc/dovecot
   ```

4. 启用并重启

   ```bash
   systemctl enable dovecot
   systemctl restart dovecot
   ```

#### 四、准备用户（如有必要）

1. 创建用户

   ```bash
   adduser su
   ```

2. 为该用户设置maildir

   ```bash
   sudo -u su maildirmake.dovecot ~/Maildir
   // 或者使用
   sudo -u mailuser maildirmake.dovecot /home/mailuser/Maildir
   ```

## 三、基础服务验证

### 1. 可ping通与DNS服务

![image-20250708225222458](https://img.lhjeong.cn/20250708225222521.png)

### 2. 文件共享

- Windows可读写Samba共享目录

  ![image-20250708225354662](https://img.lhjeong.cn/20250708225354700.png)

- 可通过FTP客户端上传下载文件

  ![image-20250708225820981](https://img.lhjeong.cn/20250708225821033.png)

### 3. 数据库

![image-20250708225950286](https://img.lhjeong.cn/20250708225950340.png)

![image-20250708230004572](https://img.lhjeong.cn/20250708230004603.png)

### 4. web服务

![image-20250708230055032](https://img.lhjeong.cn/20250708230055118.png)



![image-20250708230145513](https://img.lhjeong.cn/20250708230145565.png)

### 5. 邮件

+ 收信

  ![image-20250708233543805](https://img.lhjeong.cn/20250708233543849.png)

  ![image-20250708233614213](https://img.lhjeong.cn/20250708233614259.png)

  ![image-20250708233650334](https://img.lhjeong.cn/20250708233650377.png)

+ 发信

  ![image-20250708233325371](https://img.lhjeong.cn/20250708233325496.png)

  ![image-20250708233339322](https://img.lhjeong.cn/20250708233339376.png)


# 基于Zabbix/Prometheus和Grafana的自动化监控系统搭建与配置

## 1. Prometheus方案与基础搭建

### 1.1. 配置一台主服务器

#### 安装Prometheus

 1. 准备

    ```sh
    mkdir -p /opt/prometheus/{data,config}
    cd /opt/prometheus
    ```

2. 使用自定义网络

   ```sh
   docker network create prom-net
   ```

3. 创建配置文件

   + vim` config/prometheus.yml`

     ```yaml
     global:
       scrape_interval: 15s
     
     scrape_configs:
       - job_name: 'prometheus'
         static_configs:
           - targets: ['localhost:9090']
     
       - job_name: 'node_exporter'
         static_configs:
           - targets: ['node-exporter:9100']  // 容器名
     ```

4. 拉取镜像

   ```sh
   docker pull prom/prometheus
   docker pull prom/node-exporter
   ```

5. 启动容器

   1. 启动Node Exporter

      ```sh
      docker run -d \
        --name node-exporter \
        --network prom-net \
        prom/node-exporter
      ```

   2. 启动Prometheus

      ```sh
      docker run -d \
        --name prometheus \
        --network prom-net \
        -p 9090:9090 \
        -v /opt/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml \
        -v /opt/prometheus/data:/prometheus \
        prom/prometheus
      ```

6. 相关问题

   1. 容器启动失败

      ```sh
      // 尝试修复权限
      chown -R 65534:65534 /opt/prometheus/data
      // 重启
      docker restart prometheus
      ```

7. 效果图

   ![image-20250804172957285](https://img.lhjeong.cn/20250804172957540.png)

   ![image-20250804173024337](https://img.lhjeong.cn/20250804173024476.png)

#### 安装zabbix

1. 安装基本工具

   ```sh
   sudo apt update && sudo apt upgrade -y
   sudo apt install wget gnupg software-properties-common
   ```

2. 安装nginx和php-fpm

   ```sh
   apt install nginx
   apt install php8.2-fpm php8.2-mysql php8.2-gd php8.2-xml php8.2-bcmath php8.2-mbstring php8.2-curl
   ```

3. 配置数据库

   ```mysql
   CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
   ```

4. 导入数据库架构

   1. 安装脚本包

      ```sh
      apt install zabbix-sql-scripts
      ```

   2. 导入架构

      ```sh
      zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -h 192.168.231.3 -P 3307 -u su -p zabbix
      ```

5. 添加仓库

   ```sh
   wget https://repo.zabbix.com/zabbix/7.0/debian/pool/main/z/zabbix-release/zabbix-release_7.0-2+debian12_all.deb
   sudo dpkg -i zabbix-release_7.0-2+debian12_all.deb
   sudo apt update
   ```

6. 安装组件

   ```sh
   apt install zabbix-server-mysql zabbix-frontend-php zabbix-agent
   ```

7. 配置zabbix服务器

   + 编辑`/etc/zabbix/zabbix_server.conf`

     ```ini
     DBHost=192.168.231.3
     DBPort=3307
     DBName=zabbix
     DBUser=su
     DBPassword=123456
     ```

8. 测试数据库链接

   ```sh
   mysql -h 192.168.231.3 -u su -P 3307 -p -e "SELECT 1"
   ```

   ![image-20250801103017652](https://img.lhjeong.cn/20250801103017691.png)

9. 配置nginx和php-fpm

   1. 配置时区

      + 编辑`/etc/php/8.2/fpm/php.ini`

        ```ini
        date.timezone = Asia/shanghai
        ```

      + 保存并重启

        ```sh
        systemctl restart php8.2-fpm
        ```

   2. 创建nginx配置文件`/etc/nginx/conf.d/zabbix.conf`

      ```nginx
      server {
          listen 80;
          server_name zabbix.mxdx.com; 
          root /usr/share/zabbix;
      
          index index.php index.html;
      
          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }
      
          location ~ \.php$ {
              include fastcgi_params;
              fastcgi_pass unix:/run/php/php8.2-fpm.sock; 
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PHP_VALUE "max_execution_time=300\nmax_input_time=300\npost_max_size=16M\nupload_max_filesize=2M";
          }
      
          location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot|otf)$ {
              expires max;
              log_not_found off;
          }
      
          # 防止访问 Zabbix 的配置文件
          location ~* \.(conf|bak|sql|gz|tar|zip)$ {
              deny all;
          }
      }
      ```

      ![image-20250801142029161](https://img.lhjeong.cn/20250801142029225.png)

10. 启动配置

    ```sh
    nginx -t
    nginx -s reload
    ```

11. 设置文件权限

    ```sh
    chown -R www-data:www-data /usr/share/zabbix
    chmod -R 755 /usr/share/zabbix
    ```

12. 启动服务

    ```sh
    systemctl restart zabbix-server zabbix-agent
    systemctl enable zabbix-server zabbix-agent
    ```

13. 检查服务状态

    ```sh
    systemctl status zabbix-server
    systemctl status zabbix-agent
    ```

14. 相关问题

    1. 如果有扩展缺失

       ```sh
       apt install php8.2-mysql php8.2-gd php8.2-xml php8.2-bcmath php8.2-mbstring
       systemctl restart php8.2-fpm nginx
       ```

15. 界面展示

    ![image-20250801141942399](https://img.lhjeong.cn/20250801141942466.png)

    ![image-20250801150604862](https://img.lhjeong.cn/20250801150604979.png)

### 1.2. 配置N台从服务器

使用ansile进行批量自动化部署

1. 在主机安装ansible

   1. 准备

      ```sh
      apt update
      apt upgrade
      apt insatll curl wget vim
      apt install python3 python3-pip
      
      // 创建虚拟环境
      python3 -m venv ~/myenv
      source ~/myenv/bin/activate
      ```

   2. 安装

      ```sh
      pip3 install ansible
      ```

   3. 确认安装成功

      ```sh
      ansible --version
      ```

   4. 配置主机清单`inventory.ini`

      ```sh
      [nodes]
      node1 ansible_host=192.168.231.2 ansible_user=root ansible_ssh_pass=123456
      node2 ansible_host=192.168.231.5 ansible_user=root ansible_ssh_pass=123456
      node3 ansible_host=192.168.231.6 ansible_user=root ansible_ssh_pass=123456
      ```

   5. 下载sshpass（仅测试使用）

      ```sh
      apt update
      apt install -y sshpass
      ```

   6. 添加ssh指纹

      ```sh
      ssh root@192.168.231.2
      ssh root@192.168.231.5
      ssh root@192.168.231.6
      ```

   7. 测试

      ```
      ansible all -i /opt/ansible/inventory.ini -m ping
      ```

      ![image-20250807162410954](https://img.lhjeong.cn/20250807162411163.png)

2. 编写配置文件`playbook.yml`

   ```yaml
   - hosts: nodes
     become: yes
     tasks:
       - name: Create Node Exporter user
         user:
           name: node_exporter
           shell: /bin/false
           create_home: no
   
       - name: Create Node Exporter systemd service
         copy:
           dest: /etc/systemd/system/node_exporter.service
           content: |
             [Unit]
             Description=Prometheus Node Exporter
             After=network.target
   
             [Service]
             User=node_exporter
             Group=node_exporter
             ExecStart=/usr/local/bin/node_exporter
             Restart=always
   
             [Install]
             WantedBy=multi-user.target
   
       - name: Reload systemd daemon
         systemd:
           daemon_reload: yes
   
       - name: Start and enable Node Exporter service
         systemd:
           name: node_exporter
           state: started
           enabled: yes
   
       - name: Clean up temporary files if any
         file:
           path: /tmp/node_exporter-1.9.1.linux-amd64
           state: absent
         ignore_errors: yes
   ```

   + 本文先从主机将文件传入虚拟机，因此不包含下载、解压、移动的步骤

   + 解压

     ```sh
     tar xvfz node_exporter-1.9.1.linux-amd64.tar.gz 
     ```

   + 移动

     ```sh
     mv node_exporter-1.9.1.linux-amd64/node_exporter /usr/local/bin
     ```

3. 运行playbook

   ```sh
   ansible-playbook -i inventory.ini playbook.yml
   ```

4. 修改prometheus配置文件`/opt/prometheus/config/prometheus.yml`

   ```yaml
   - job_name: 'node_exporters'
       static_configs:
         - targets:
             - '192.168.231.2:9100'
             - '192.168.231.5:9100'
             - '192.168.231.6:9100'
   ```

   ![image-20250807163339783](https://img.lhjeong.cn/20250807163339822.png)

5. 重启prometheus

   ```sh
   docker restart Prometheus
   ```

   ![image-20250807164711076](https://img.lhjeong.cn/20250807164711268.png)

### 1.3. 配置Grafana

1. 安装

   ```sh
   docker run -d \
     --name=grafana \
     -p 3000:3000 \
     -v grafana-storage:/var/lib/grafana \
     grafana/grafana-oss
   ```

   + 用户和密码为admin

2. 添加Prometheus为数据源

3. 导入仪表盘

4. 验证效果

   ![image-20250807165259755](https://img.lhjeong.cn/20250807165300083.png)

## 2. Zabbix方案

### 2.1 使用Ansible进行批量自动化部署

1. 创建playbook文件，如`deploy_zabbix_agent.yml`

   ```yaml
   ---
   - hosts: nodes
     become: yes
     vars:
       zabbix_server_ip: "192.168.231.4"
     tasks:
       - name: Add Zabbix repository
         get_url:
           url: https://repo.zabbix.com/zabbix/6.0/debian/pool/main/z/zabbix-release/zabbix-release_6.0-4+debian12_all.deb
           dest: /tmp/zabbix-release.deb
       - name: Install Zabbix repository
         apt:
           deb: /tmp/zabbix-release.deb
       - name: Update apt cache
         apt:
           update_cache: yes
       - name: Install Zabbix Agent
         apt:
           name: zabbix-agent
           state: present
       - name: Configure Zabbix Agent
         template:
           src: zabbix_agentd.conf.j2
           dest: /etc/zabbix/zabbix_agentd.conf
           mode: '0644'
       - name: Start and enable Zabbix Agent
         systemd:
           name: zabbix-agent
           state: started
           enabled: yes
       - name: Clean up downloaded files
         file:
           path: /tmp/zabbix-release.deb
           state: absent
   ```

2. 创建模板文件`zabbix_agentd.conf.j2`

   ```ini
   LogFile=/var/log/zabbix-agent/zabbix_agentd.log
   
   ListenPort=10050
   ListenIP=0.0.0.0
   
   Server={{ zabbix_server_ip }}
   ServerActive={{ zabbix_server_ip }}
   Hostname={{ ansible_hostname }}
   ```

3. 执行

   ```sh
   ansible-playbook -i inventory.ini deploy_zabbix_agent.yml
   ```

   ![image-20250807171625745](https://img.lhjeong.cn/20250807171625922.png)

4. 相关问题

   1. zabbix用户无权

      ```sh
      chown -R zabbix:zabbix /var/log/zabbix-agent/
      ```

   2. 配置文件修改

      ```ini
      LogFile=/var/log/zabbix-agent/zabbix_agentd.log
      
      ListenPort=10050
      ListenIP=0.0.0.0
      
      Server=192.168.231.4
      ServerActive=192.168.231.4
      Hostname=test2
      ```

   3. 查看服务

      ```sh
      systemctl status zabbix-agent.service
      ```

      ![image-20250808083621856](https://img.lhjeong.cn/20250808083621916.png)

### 2.2. Zabbix和Grafana配置

1. 在zabbix中添加主机

   1. 配置示例

      ![image-20250808093601460](https://img.lhjeong.cn/20250808093601539.png)

2. 全部添加展示

   ![image-20250808093644099](https://img.lhjeong.cn/20250808093644172.png)



3. 在Grafana中导入仪表盘

   ![image-20250808093800623](https://img.lhjeong.cn/20250808093800772.png)

## 3. 配置告警触发器和邮件告警

### 3.1. Zabbix方案

1. 设置触发器

   ![image-20250808151116590](https://img.lhjeong.cn/20250808151117071.png)

2. 设置媒介

   ![image-20250808151220009](https://img.lhjeong.cn/20250808151238464.png)

   + 消息模板（问题）

     ```
     告警主机: {HOST.NAME}
     告警时间: {EVENT.DATE} {EVENT.TIME}
     告警级别: {TRIGGER.SEVERITY}
     告警信息: {TRIGGER.NAME}
     当前值: {ITEM.LASTVALUE}
     触发原因: CPU使用率持续高于80%
     ```

     ![image-20250808151401772](https://img.lhjeong.cn/20250808151401894.png)

   + 消息模板（恢复）

     ```
     恢复主机:{HOST.NAME}
     恢复时间:{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}
     持续时间:{EVENT.DURATION}
     告警等级:{TRIGGER.SEVERITY}
     告警信息:{TRIGGER.NAME}
     告警项目:{ITEM.KEY}
     问题详情:{ITEM.NAME}:{ITEM.VALUE}
     当前状态:{TRIGGER.STATUS}:{ITEM.VALUE1}
     恢复事件ID:{EVENT.RECOVERY.ID}
     ```

     ![image-20250808151434500](https://img.lhjeong.cn/20250808151434608.png)

3. 设置触发器动作

   + 动作

     ![image-20250808151546193](https://img.lhjeong.cn/20250808151546241.png)

   + 操作

     ![image-20250808151613010](https://img.lhjeong.cn/20250808151613199.png)

4. 设置用户报警媒介

   ![image-20250808151715237](https://img.lhjeong.cn/20250808151715285.png)

5. 邮件展示

   + 警告

     ![image-20250808165737569](https://img.lhjeong.cn/20250808165737741.png)

   + 恢复

     ![image-20250808165756680](https://img.lhjeong.cn/20250808165756729.png)

### 3.2. Prometheus方案

1. 下载alertmanager

   1. 编写`alertmanager.yml`

      ```yaml
      global:
        smtp_smarthost: 'mail.mxdx.com:587'         # 邮件服务器地址和端口
        smtp_from: 'su@mail.mxdx.com'               # 发件邮箱
        smtp_auth_username: 'su'                    # SMTP 登录用户名
        smtp_auth_password: '123456'                # 密码
        smtp_require_tls: true
        smtp_tls_config:
          insecure_skip_verify: true
      
      route:
        receiver: 'admin-email'
      
      receivers:
      - name: 'admin-email'
        email_configs:
        - to: 'jeong@mail.mxdx.com'                    
          send_resolved: true                       
      ```

   2. 启动

      ```sh
      docker run -d --name=alertmanager \
        -p 9093:9093 \
        -v /opt/alertmanager:/etc/alertmanager \
        prom/alertmanager
      ```

2. 给prometheus加上告警规则`/opt/prometheus/alert.rules.yml`

   ```sh
   groups:
   - name: cpu-alert
     rules:
     - alert: HighCPUUsage
       expr: avg(rate(node_cpu_seconds_total{mode!="idle"}[1m])) * 100 > 80
       for: 1m
       labels:
         severity: critical
       annotations:
         summary: "CPU 使用率过高"
         description: "CPU 已持续 1 分钟高于 80%"
   ```

3. 修改prometheus的配置文件`/opt/prometheus/config/prometheus.yml`

   ```yaml
   global:
     scrape_interval: 15s
   
   rule_files:
     - "alert.rules.yml"
   
   alerting:
     alertmanagers:
     - static_configs:
       - targets: 
           - 'alertmanager:9093'
   
   scrape_configs:
     - job_name: 'prometheus'
       static_configs:
         - targets: ['localhost:9090']
   
     - job_name: 'node_exporter'
       static_configs:
         - targets: ['node-exporter:9100']
   
     - job_name: 'node_exporters'
       static_configs:
         - targets:
             - '192.168.231.2:9100'
             - '192.168.231.5:9100'
             - '192.168.231.6:9100'
   ```

4. 重启

   ```sh
   docker restart prometheus
   ```

5. 测试

   ```sh
   apt install stress
   stress --cpu 4 --timeout 60
   ```

6. 问题

   + docker启动参数要挂载规则文件

     ```sh
     docker run -d \
       --name=prometheus \
       -p 9090:9090 \
       -v /opt/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml \
       -v /opt/prometheus/config/alert.rules.yml:/etc/prometheus/alert.rules.yml \
       prom/prometheus
     ```

7. 邮件展示

   + 警告

     ![image-20250808165903688](https://img.lhjeong.cn/20250808165903745.png)

   + 恢复

     ![image-20250808165921554](https://img.lhjeong.cn/20250808165921606.png)

## 4. 自动化构建

### 4.1. 安装Jenkins

1. 安装java

   ```sh
   apt install -y openjdk-17-jdk
   ```


2. 添加仓库

   ```sh
   curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo tee /usr/share/keyrings/jenkins-keyring.asc > /dev/null
   
   echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/ | sudo tee /etc/apt/sources.list.d/jenkins.list
   ```

3. 安装jenkins

   ```sh
   apt update
   apt install -y jenkins
   ```

4. 启动

   ```sh
   systemctl start jenkins
   systemctl enable jenkins
   ```

5. 验证

   ```sh
   systemctl status jenkins
   ```

6. 解决端口占用`/etc/default/jenkins`

   ```ini
   HTTP_PORT=8095
   
   vim /lib/systemd/system/jenkins.service
   ExecStart=/usr/bin/jenkins --httpPort=8095
   
   systemctl restart jenkins
   ```

7. 展示

   ![image-20250731165936888](https://img.lhjeong.cn/20250731165937298.png)

8. 下载插件

   + Pipeline
   + SSH Agent
   + AnsiColor

9. 验证运行

   1. 切换到jenkins用户

      ```sh
      sudo su - jenkins
      ```

   2. 激活python环境

      ```sh
      python3 -m venv ~/myenv
      source ~/myenv/bin/activate
      ```

   3. 测试运行

      ```sh
      cd /opt/ansible
      ansible-playbook -i inventory.ini test.yml
      ```

10. 创建任务

    1. 选择自由风格项目

    2. 添加脚本

       ```sh
       #!/bin/bash
       python3 -m venv /var/lib/jenkins/myenv
       . /var/lib/jenkins/myenv/bin/activate
       cd /opt/ansible
       ansible-playbook -i inventory.ini test.yml
       ```

    3. 点击运行

       ![image-20250804151341783](https://img.lhjeong.cn/20250804151341929.png)

11. 添加自由任务

    + Prometheus方案

      ```sh
      #!/bin/bash
      python3 -m venv ~/myenv
      source ~/myenv/bin/activate
      cd /opt/ansible
      ansible-playbook -i inventory.ini playbook.yml
      ```

      ![image-20250811082354171](https://img.lhjeong.cn/20250811082354279.png)

    + zabbix方案

      ```sh
      #!/bin/bash
      python3 -m venv ~/myenv
      source ~/myenv/bin/activate
      cd /opt/ansible
      ansible-playbook -i inventory.ini deploy_zabbix_agent.yml
      ```

      ![image-20250811082258846](https://img.lhjeong.cn/20250811082258950.png)

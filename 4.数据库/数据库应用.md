### 阶段0

1. 确认能登录 MySQL  
2. 确认 Discuz 库存在  

![image-20250717111550060](https://img.lhjeong.cn/20250717111550211.png)

### 阶段1

1. 列出所有索引  

   ![image-20250717112328612](https://img.lhjeong.cn/20250717112328848.png)

2. 手工删除你认为影响查询的 **3 个索引**（比如 tid、authorid、dateline）

   authorid、dateline、invisible

   ![image-20250717113842418](https://img.lhjeong.cn/20250717113842592.png)

### 阶段2

+ SQL + Shell 注入法

  ```sh
  #!/bin/bash
  
  BATCH=1000
  TOTAL=500000
  OUT=gen_post_data.sql
  
  echo "USE discuz;" > $OUT
  
  for ((i=1; i<=$TOTAL; i+=$BATCH)); do
      echo -n "INSERT INTO pre_forum_post (pid, fid, tid, repid, first, author, authorid, subject, dateline, lastupdate, updateuid, premsg, message, useip, port, invisible, anonymous, usesig, htmlon, bbcodeoff, smileyoff, parseurloff, attachment, rate, ratetimes, status, tags, comment, replycredit, position) VALUES" >> $OUT
      for ((j=0; j<$BATCH; j++)); do
          ID=$((i+j))
          NOW=$(date +%s)
          echo -n "($ID, 1, 1, 0, 0, 'user$ID', 1, 'test_$ID', $NOW, $NOW, 0, '', 'content_$ID', '', 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, '0', 0, 0, $ID)" >> $OUT
          if [ $j -lt $((BATCH-1)) ]; then
              echo -n "," >> $OUT
          else
              echo ";" >> $OUT
          fi
      done
  done
  
  echo "已生成 $TOTAL 条数据到 $OUT"
  ```

  ![image-20250717153401232](https://img.lhjeong.cn/20250717153401319.png)

### 阶段3

1. 打开慢日志  

   ```sql
   SET GLOBAL slow_query_log = 1;
   SET GLOBAL long_query_time = 0.2;
   ```

   ![image-20250717160700609](https://img.lhjeong.cn/20250717160700764.png)

2. 自己写 **3 条** 典型慢 SQL（示例供思路）  

   - 按作者查最新 20 帖

     ![image-20250717161659714](https://img.lhjeong.cn/20250717161659784.png)

   - 统计某主题回复数

     ![image-20250717161721226](https://img.lhjeong.cn/20250717161721318.png)

   - 模糊搜索标题

     ![image-20250717163211959](https://img.lhjeong.cn/20250717163212009.png)

3. 记录 **耗时** 和 **EXPLAIN rows** 截图。

   ![image-20250717164539814](https://img.lhjeong.cn/20250717164540061.png)

   ![image-20250717164713226](https://img.lhjeong.cn/20250717164713547.png)

### 阶段4

+ 优化1

  ```
  EXPLAIN ANALYZE SELECT * FROM pre_forum_post WHERE authorid=1 ORDER BY dateline DESC LIMIT 20;
  ```

  ![image-20250717171850723](https://img.lhjeong.cn/20250717171850777.png)

  ![image-20250717171905452](https://img.lhjeong.cn/20250717171905588.png)

+ 优化2

  ```
  ALTER TABLE pre_forum_post ADD FULLTEXT INDEX idx_subject_fulltext (subject);
  SELECT * FROM pre_forum_post WHERE MATCH(subject) AGAINST('test_1');
  ```

  ![image-20250717171819002](https://img.lhjeong.cn/20250717171819213.png)

### 阶段5

+ 需要保证二者的server_id不一样

1. 主库配置

   ```
   vim /etc/mysql/mysql.conf.d/mysqld.cnf
   
   [mysqld]
   server-id=1
   log-bin=mysql-bin
   binlog_format=ROW
   
   // 重启
   ```

   ![image-20250717172230850](https://img.lhjeong.cn/20250717172230912.png)

   + 查看是否启用了binlog

     ```mysql
     SHOW VARIABLES LIKE 'log_bin';
     ```

2. 在主库创建复制账号

   ```sql
   mysql> create user 'repl'@'%' identified by '123456';
   ERROR 2013 (HY000): Lost connection to MySQL server during query
   No connection. Trying to reconnect...
   Connection id:    9
   Current database: discuz
   
   Query OK, 0 rows affected (1.82 sec)
   
   mysql> grant replication slave on *.* to 'repl'@'%';
   Query OK, 0 rows affected (0.01 sec)
   
   mysql> FLUSH PRIVILEGES;
   Query OK, 0 rows affected (0.01 sec)
   ```

   ![image-20250717173310737](https://img.lhjeong.cn/20250717173310832.png)

3. 锁定所有表保证数据一致性并查看当前二进制日志位点

   ```sql
   FLUSH TABLES WITH READ LOCK;
   
   SHOW MASTER STATUS;
   ```

   ![image-20250717232550297](https://img.lhjeong.cn/20250717232550398.png)

4. 新开个终端导出数据库

   ```sh
   mysqldump -uroot -p --databases discuz --single-transaction --master-data=2 --flush-logs --hex-blob > /tmp/discuz.sql
   ```

5. 回到刚刚的终端

   ```sql
   UNLOCK TABLES;
   ```

6. 将`discuz.sql`上传到192.168.231.2

7. 在从库的虚拟机执行

   ```sh
   docker cp /root/discuz.sql mysql-slave:/root/
   ```

8. 进入从库容器

   ```sql
   docker exec -it mysql-slave bash
   
   mysql -u root -p
   
   // 执行数据库
   source /root/discuz.sql;
   ```

9. 停止当前复制

   ```sql
   STOP SLAVE;
   RESET SLAVE ALL;
   ```

10. 配置主库连接信息

    ```sql
    CHANGE MASTER TO
      MASTER_HOST='192.168.231.3',
      MASTER_PORT=3307,
      MASTER_USER='repl',
      MASTER_PASSWORD='123456',
      MASTER_LOG_FILE='binlog.000050',
      MASTER_LOG_POS=157;
    ```

11. 启动复制并检查状态

    ```sql
    // 启动复制
    START SLAVE;
    // 检查状态
    SHOW SLAVE STATUS\G
    ```

![image-20250720232007649](https://img.lhjeong.cn/20250720232008034.png)

### 阶段6

1. 安装

   ```sh
   wget https://github.com/sysown/proxysql/releases/download/v2.5.5/proxysql_2.5.5-debian11_amd64.deb
   // 当然，本文出于下载速度考虑，推荐主机下载上传
   https://github.com/sysown/proxysql/releases
   apt install ./proxysql_3.0.1-dbg-debian12_amd64.deb
   
   // 修改配置文件
      vim /etc/proxysql.cnf
      mysql_servers = (
       { address = "192.168.231.3", port = 3307, hostgroup = 0, weight = 100 },
       { address = "192.168.231.2", port = 3306, hostgroup = 1, weight = 100 }
   )
   ```

2. 连接到管理界面

   ```sh
   mysql -u admin -p -h 127.0.0.1 -P 6032
   // 默认密码为admin
   ```

3. 插入用户并验证

   ```sql
   // 插入用户
   INSERT INTO mysql_users (username, password, default_hostgroup)
   VALUES ('repl', '123456', 0);
   
   // 验证
   SELECT * FROM mysql_users;
   ```

4. 配置读写分离

   ```sql
   -- 将所有的 SELECT 查询转发到从库
   INSERT INTO mysql_query_rules (active, match_pattern, destination_hostgroup)
   VALUES (1, '^SELECT', 1);
   
   -- 将 INSERT, UPDATE, DELETE 等操作转发到主库
   INSERT INTO mysql_query_rules (active, match_pattern, destination_hostgroup)
   VALUES (1, '^INSERT|^UPDATE|^DELETE', 0);
   ```

5. 保存配置

   ```sql
   -- 加载规则到内存
   LOAD MYSQL QUERY RULES TO RUNTIME;
   -- 保存到磁盘
   SAVE MYSQL QUERY RULES TO DISK;
   ```

6. 检查状态

   ```sql
   // 查看规则是否加载并生效
   SELECT * FROM mysql_query_rules;
   // 查看是否识别到了主库和从库
   SELECT * FROM mysql_servers;
   
   // 如果mysql_servers里没有东西，执行-->
   -- 添加主库（port: 3307）
   INSERT INTO mysql_servers (hostgroup_id, hostname, port, weight, max_connections)
   VALUES (0, '192.168.231.3', 3307, 100, 200);
   
   -- 添加从库（port: 3306）
   INSERT INTO mysql_servers (hostgroup_id, hostname, port, weight, max_connections)
   VALUES (1, '192.168.231.2', 3306, 100, 200);
   
   // 加载配置
   LOAD MYSQL SERVERS TO RUNTIME;
   SAVE MYSQL SERVERS TO DISK;
   
   // 再次检查
   SELECT * FROM mysql_servers;
   ```

![image-20250721091907191](https://img.lhjeong.cn/20250721091907350.png)

7. 压力测试

   + 准备工作

     1. 下载工具

        ```sh
        apt install sysbench
        ```

     2. 建库

        ```sql
        CREATE DATABASE sbtest;
        ```

     3. 准备测试数据

        ```sh
        sysbench \
          --db-driver=mysql \
          --mysql-user=root \
          --mysql-password=123456 \
          --mysql-host=127.0.0.1 \
          --mysql-port=3307 \
          --mysql-db=sbtest \
          --tables=5 \
          --table-size=100000 \
          oltp_read_write \
          prepare
        ```

     4. 开始压力测试

        ```sh
        sysbench \
          --threads=10 \
          --time=60 \
          --report-interval=10 \
          --db-driver=mysql \
          --mysql-user=root \
          --mysql-password=123456 \
          --mysql-host=127.0.0.1 \
          --mysql-port=3307 \
          --mysql-db=sbtest \
          oltp_read_write \
          run
        ```

     5. 清理数据

        ```sh
        sysbench \
          --db-driver=mysql \
          --mysql-user=root \
          --mysql-password=123456 \
          --mysql-host=127.0.0.1 \
          --mysql-port=3307 \
          --mysql-db=sbtest \
          oltp_read_write \
          cleanup
        ```

        

   + 开启读写分离前

     ![image-20250723152923832](https://img.lhjeong.cn/20250723152924069.png)

   + 开启读写分离后

     ![image-20250723153959602](https://img.lhjeong.cn/20250723153959937.png)

### 阶段7

1. 查看是否开启了binlog

   ```sql
   SHOW VARIABLES LIKE 'log_bin';
   ```

   + 未开启可编辑/etc/mysql/my.cnf

     ```ini
     [mysql]
     log-bin=mysql-bin
     
     // 然后重启
     ```

2. 删除表

   ```sql
   USE dz2_discuz;
   DROP TABLE pre_forum_post;
   // 确认表真的被删了
   SHOW TABLES LIKE 'pre_forum_post';
   ```


3. 查看binlog文件
	```sql
    SHOW BINARY LOGS;
    // 不一定是最新的，要查看文件大小
4. 提取恢复语句
   ```
    mysqlbinlog --no-defaults \
    --start-datetime='2025-07-17 15:19:00' \
    --stop-datetime='2025-07-17 15:22:00' \
    /usr/local/mysql/data/binlog.000048 > /tmp/rollback_insert_post.sql
   ```

+ 这里的时间是操作数据库的时间，而非你删除数据库表的时间

+ 如果你不记得时间，可执行------>

	```sh
  mysqlbinlog --no-defaults --base64-output=DECODE-ROWS \
    --verbose /usr/local/mysql/data/binlog.000048 | grep -B 10 "INSERT INTO \`discuz\`.\`pre_forum_post\`" | less
  ```

+ 开始时间要向前填写一点，结束时间要向后填写一点，以确保完整保留恢复语句

![image-20250722094118322](https://img.lhjeong.cn/20250722094118529.png)

### 特别扩展

#### 1. 主从复制GTID

1. 修改主库配置文件（/etc/my.cnf   或者  /etc/mysql/my.cnf）

   ```ini
   server-id=1
   log-bin=mysql-bin
   enforce-gtid-consistency=true
   gtid-mode=ON
   binlog-format=ROW
```

2. 修改从库配置文件（/etc/my.cnf   或者  /etc/mysql/my.cnf）

   ```ini
   server-id=2
   log-bin=mysql-bin
   relay-log=relay-bin
   log-slave-updates=ON
   enforce-gtid-consistency=ON
   gtid-mode=ON
   read-only=ON
```

3. 重启主库和从库的mysql

4. 创建复制用户（主库执行，如果有就不执行）

   ```sql
   CREATE USER 'repl'@'%' IDENTIFIED BY '123456';
   GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
   ```

5. 获取主库GTUD状态

   ```sql
   SHOW MASTER STATUS;
   ```

6. 重建主从关系

   ```sql
   STOP SLAVE;
   RESET SLAVE ALL;
   ```

7. 从主库中导出数据，确保主从库数据一致

   ```sh
   mysqldump -u root -p123456 -P3307 --all-databases --single-transaction --flush-logs --master-data=2 > full_backup.sql
   ```

8. 将文件导入从库

   ```sh
   mysql -uroot -p < full.sql
   ```

9. 配置主从复制（在从库）

   ```sql
   CHANGE MASTER TO
     MASTER_HOST='192.168.231.3',
     MASTER_PORT=3307,
     MASTER_USER='repl',
     MASTER_PASSWORD='123456',
     MASTER_AUTO_POSITION = 1;
   
   START SLAVE;
   ```

10. 确认复制状态正常

    ```mysql
    SHOW SLAVE STATUS\G
    
    // 应显示为以下
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
    Auto_Position: 1
    ```


#### 2. 建议开启MIXED

1. 在数据库配置文件中加入

   ```ini
   binlog_format = mixed
   ```

   

